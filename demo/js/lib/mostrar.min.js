// https://github.com/synesenom/mostrar v0.0.1 Copyright 2020 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mostrar={},t.d3)}(this,(function(t,e){"use strict";function n(t){let e={GET:()=>t};return e}function s(t){const s="enter",r="update",o="exit",a={id:t.id,selection:e.select(t),selectors:new Set((i=t,["#"+i.id].concat(i.classList.toString().split(" ").map((t=>"."+t)).sort()))),states:[]};var i;function c(t){return t.filter((t=>a.selectors.has(t))).length>0}function l(t,e){return Object.keys(t).forEach((n=>{t[n]=a.selection[e](n)||null})),t}function u(t){return e.max((t||[]).map((t=>t.duration||0)).concat(0))}function d(t){return e.max((t||[]).map((t=>t.delay||0)).concat(0))}function f(t){return t.map((t=>t.attr)).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{})}function y(t){return t.map((t=>t.style)).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{})}function p(t){let e=function(t){return(t.enter||[]).filter((t=>c(t.selector)))}(t);return e.length>0?{entries:e,type:s}:(e=function(t){return(t.update||[]).filter((t=>c(t.selector)))}(t),e.length>0?{entries:e,type:r}:(e=function(t){return(t.exit||[]).filter((t=>c(t.selector)))}(t),e.length>0?{entries:e,type:o}:{}))}function b(t,e){return Object.entries(e).forEach((([e,n])=>t.style(e,n))),t}function m(t,e){return Object.entries(e).forEach((([e,n])=>t.attr(e,n))),t}const h={init:t=>{let e="none"!==a.selection.style("display");const r=function(t){return t.map((t=>t.update)).concat(t.map((t=>t.enter))).concat(t.map((t=>t.exit))).filter((t=>void 0!==t)).flat()}(t),i=l(y(r),"style"),c=l(f(r),"attr");return a.states.push(n({id:0,visible:e,duration:0,delay:0,style:Object.assign({},i),attr:Object.assign({},c)})),t.forEach((t=>{const{entries:r,type:l}=p(t);switch(void 0!==r&&(Object.assign(i,y(r)),Object.assign(c,f(r))),l){case s:e=!0;break;case o:e=!1}a.states.push(n({id:t.id,visible:e,duration:u(r),delay:d(r),style:Object.assign({},i),attr:Object.assign({},c)}))})),h}};return h.toFrame=(t,e)=>{const n=(i=a.states[t].GET().visible,c=a.states[e].GET().visible,!i&&c?s:i&&!c?o:i&&c?r:void 0);var i,c;const l=a.states[e].GET().duration||a.states[t].GET().duration,u=a.states[e].GET().delay||a.states[t].GET().delay;switch(n){case s:{const n=b(a.selection,a.states[t].GET().style).style("display",null).interrupt().transition().duration(l).delay(u);b(n,a.states[e].GET().style),m(n,a.states[e].GET().attr);break}default:case r:{const s=void 0===n?a.selection:a.selection.interrupt().transition().duration(l).delay(u);b(s,function(t,e){const n={};for(const s in t)t.hasOwnProperty(s)&&e.hasOwnProperty(s)&&(t[s]!==e[s]||a.selection.style(s)!==e[s])&&(n[s]=e[s]);return n}(a.states[t].GET().style,a.states[e].GET().style)),m(s,function(t,e){const n={};for(const s in t)t.hasOwnProperty(s)&&e.hasOwnProperty(s)&&(t[s]!==e[s]||a.selection.attr(s)!==e[s])&&(n[s]=e[s]);return n}(a.states[t].GET().attr,a.states[e].GET().attr));break}case o:{const t=a.selection.interrupt().transition().duration(l).delay(u);b(t,a.states[e].GET().style),m(t,a.states[e].GET().attr),t.on("end",(()=>a.selection.style("display","none")));break}}return h},h}t.Scene=function(t){let n={frames:[],current:0,objects:[]};function r(t){n.objects.map((e=>e.toFrame(n.current,t))),n.current=t}const o={forward:()=>(n.frames.length>n.current&&r(n.current+1),o),backward:()=>(n.current>0&&r(n.current-1),o),jumpTo:t=>(t!==n.current&&t>=0&&t<=n.frames.length&&r(t),o),init:r=>(n.frames=r,n.objects=e.select(t).selectAll(".obj").nodes().map((t=>s(t).init(n.frames))),o),controls:t=>{const n=t.forward||[],s=t.backward||[],r=t.bookmarks||{};return e.select("body").on("keydown.controls",(t=>{if(n.indexOf(t.code)>-1)o.forward();else{s.indexOf(t.code)>-1&&o.backward();for(const e in r)t.code===e&&r.hasOwnProperty(e)&&o.jumpTo(r[e])}})),o}};return o},Object.defineProperty(t,"__esModule",{value:!0})}));
