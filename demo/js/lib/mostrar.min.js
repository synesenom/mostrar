// https://github.com/synesenom/mostrar v0.1.5 Copyright 2020 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3"),require("js-yaml"),require("json-stable-stringify")):"function"==typeof define&&define.amd?define(["exports","d3","js-yaml","json-stable-stringify"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mostrar={},t.d3,t.jsyaml)}(this,(function(t,e,s){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=n(s);const a="enter",i="update",o="exit";function l(t){const e={attr:t.attr||{},style:t.style||{},delay:t.delay||0,duration:t.duration||0,selector:t.selector||[]},s={GET:()=>t,includes:t=>{const s=new Set(t||[]);return e.selector.filter((t=>s.has(t))).length>0},getAttributes:()=>e.attr,getStyle:()=>e.style,getDelay:()=>e.delay,getDuration:()=>e.duration};return s}function c(t,s){const n={transitions:(t||[]).map(l)},r={getType:()=>s,getAttributes:t=>{const e=n.transitions.map((t=>t.getAttributes())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((s=>{e[s]=t.attr(s)||null})),e},getStyle:t=>{const e=n.transitions.map((t=>t.getStyle())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((s=>{e[s]=t.style(s)||null})),e},getMaxDelay:()=>e.max(n.transitions.map((t=>t.getDelay())))||0,getMaxDuration:()=>e.max(n.transitions.map((t=>t.getDuration())))||0};return r}const u="enter",d="update",y="exit";function p(t){const e={enter:t.enter||[],exit:t.exit||[],update:t.update||[]};const s={};return s.getRelevantEntries=t=>{let s=function(t){return e.enter.map(l).filter((e=>e.includes(t))).map((t=>t.GET()))}(t);return s.length>0?c(s,u):(s=function(t){return e.update.map(l).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),s.length>0?c(s,d):(s=function(t){return e.exit.map(l).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),s.length>0?c(s,y):c()))},s}function g(t){const e={style:Object.assign({},t)},s={get:()=>e.style,apply:t=>(Object.entries(e.style).forEach((([e,s])=>t.style(e,s))),t),diff:(t,s)=>g(Object.entries(t.get()).reduce(((t,[n,r])=>(r===e.style[n]&&r===s.style(n)||(t[n]=r),t)),{}))};return s}function f(t){const e={attributes:Object.assign({},t)},s={get:()=>e.attributes,apply:t=>(Object.entries(e.attributes).forEach((([e,s])=>t.attr(e,s))),t),diff:(t,s)=>f(Object.entries(t.get()).reduce(((t,[n,r])=>(r===e.attributes[n]&&r===s.attr(n)||(t[n]=r),t)),{}))};return s}function b(t){const e={visible:t.visible,duration:t.duration||0,delay:t.delay||0,style:g(t.style),attr:f(t.attr)},s={getDuration:()=>e.duration,getDelay:()=>e.delay,getStyle:()=>e.style,getAttributes:()=>e.attr,getVisible:()=>e.visible,getTransitionType:t=>!e.visible&&t.getVisible()?a:e.visible&&!t.getVisible()?o:e.visible&&t.getVisible()?i:void 0};return s}function m(t){const s={selection:e.select(t),selectors:new Set((n=t,["#"+n.id].concat(n.classList.toString().split(" ").map((t=>"."+t)).sort()))),states:[]};var n;const r={};return r.init=t=>{const e=function(t){return{getTransitions:()=>c(t.map((t=>t.update)).concat(t.map((t=>t.enter))).concat(t.map((t=>t.exit))).filter((t=>void 0!==t)).flat()),getFrames:()=>t.map(p)}}(t),n=e.getTransitions();let i="none"!==s.selection.style("display");const l=n.getStyle(s.selection),u=n.getAttributes(s.selection);return s.states.push(b({visible:i,duration:0,delay:0,style:l,attr:u})),e.getFrames().forEach((t=>{const e=t.getRelevantEntries(s.selectors);switch(void 0!==e.getType()&&(Object.assign(l,e.getStyle()),Object.assign(u,e.getAttributes())),e.getType()){case a:i=!0;break;case o:i=!1}s.states.push(b({visible:i,duration:e.getMaxDuration(),delay:e.getMaxDelay(),style:l,attr:u}))})),r},r.toFrame=(t,e)=>{const n=s.states[t].getTransitionType(s.states[e]),l=s.states[e].getDuration()||s.states[t].getDuration(),c=s.states[e].getDelay()||s.states[t].getDelay();switch(n){case a:{const n=s.states[t].getStyle().apply(s.selection).style("display",null).interrupt().transition().duration(l).delay(c);s.states[e].getStyle().apply(n),s.states[e].getAttributes().apply(n);break}default:case i:{const r=void 0===n?s.selection:s.selection.interrupt().transition().duration(l).delay(c);s.states[t].getStyle().diff(s.states[e].getStyle(),s.selection).apply(r),s.states[t].getAttributes().diff(s.states[e].getAttributes(),s.selection).apply(r);break}case o:{const t=s.selection.interrupt().transition().duration(l).delay(c).on("end",(()=>s.selection.style("display","none")));s.states[e].getStyle().apply(t),s.states[e].getAttributes().apply(t);break}}return r},r}t.Scene=function(t){const s="mo";let n={frames:[],current:0,objects:[]};function a(t){return Object.entries(t||[]).map((([t,e])=>Object.assign(e,{selector:t.split(" ")})))}function i(t){n.objects.forEach((e=>e.toFrame(n.current,t))),n.current=t}const o={forward:()=>(n.frames.length>n.current&&i(n.current+1),o),backward:()=>(n.current>0&&i(n.current-1),o),jumpTo:t=>(t!==n.current&&t>=0&&t<=n.frames.length&&i(t),o),init:async i=>{const l=r.default.load(await e.text(i));return n.frames=Object.entries(l).map((([t,e])=>({name:t,enter:a(e.enter),update:a(e.update),exit:a(e.exit)}))).sort(((t,e)=>t.name.localeCompare(e.name))).map(((t,e)=>Object.assign(t,{index:e}))),n.objects=e.select(t).selectAll("."+s).nodes().map((t=>m(t).init(n.frames))),o},controls:t=>{const s=t.forward||[],n=t.backward||[],r=t.bookmarks||{};return e.select("body").on("keydown.controls",(()=>{if(s.indexOf(e.event.code)>-1)o.forward();else{n.indexOf(e.event.code)>-1&&o.backward();for(const t in r)e.event.code===t&&r.hasOwnProperty(t)&&o.jumpTo(r[t])}})),o}};return o},Object.defineProperty(t,"__esModule",{value:!0})}));
