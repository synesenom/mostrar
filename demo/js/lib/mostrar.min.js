// https://github.com/synesenom/mostrar v0.0.2 Copyright 2020 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3"),require("json-stable-stringify")):"function"==typeof define&&define.amd?define(["exports","d3","json-stable-stringify"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mostrar={},t.d3)}(this,(function(t,e){"use strict";function s(t,e,s,n){const r=document.createElement(e);for(let e=0;e<t.attributes.length;e++)r.setAttribute(t.attributes.item(e).nodeName,t.attributes.item(e).nodeValue);Array.isArray(s)&&r.classList.add(...s),"object"==typeof n&&Object.entries(n).forEach((([t,e])=>{r.style.setProperty(t,e)})),r.innerHTML=t.innerHTML,t.parentNode.replaceChild(r,t)}function n(t,e,n,r){let i=document.querySelector(t);for(;null!==i;)s(i,e,n,r),i=document.querySelector(t)}const r="enter",i="update",a="exit";function o(t){const e={attr:t.attr||{},style:t.style||{},delay:t.delay||0,duration:t.duration||0,selector:t.selector||[]},s={GET:()=>t,includes:t=>{const s=new Set(t||[]);return e.selector.filter((t=>s.has(t))).length>0},getAttributes:()=>e.attr,getStyle:()=>e.style,getDelay:()=>e.delay,getDuration:()=>e.duration};return s}function l(t,s){const n={transitions:(t||[]).map(o)},r={getType:()=>s,getAttributes:t=>{const e=n.transitions.map((t=>t.getAttributes())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((s=>{e[s]=t.attr(s)||null})),e},getStyle:t=>{const e=n.transitions.map((t=>t.getStyle())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((s=>{e[s]=t.style(s)||null})),e},getMaxDelay:()=>e.max(n.transitions.map((t=>t.getDelay())))||0,getMaxDuration:()=>e.max(n.transitions.map((t=>t.getDuration())))||0};return r}const c="enter",u="update",d="exit";function y(t){const e={enter:t.enter||[],exit:t.exit||[],update:t.update||[]};const s={};return s.getRelevantEntries=t=>{let s=function(t){return e.enter.map(o).filter((e=>e.includes(t))).map((t=>t.GET()))}(t);return s.length>0?l(s,c):(s=function(t){return e.update.map(o).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),s.length>0?l(s,u):(s=function(t){return e.exit.map(o).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),s.length>0?l(s,d):l()))},s}function g(t){const e={style:Object.assign({},t)},s={get:()=>e.style,apply:t=>(Object.entries(e.style).forEach((([e,s])=>t.style(e,s))),t),diff:(t,s)=>g(Object.entries(t.get()).reduce(((t,[n,r])=>(r===e.style[n]&&r===s.style(n)||(t[n]=r),t)),{}))};return s}function p(t){const e={attributes:Object.assign({},t)},s={get:()=>e.attributes,apply:t=>(Object.entries(e.attributes).forEach((([e,s])=>t.attr(e,s))),t),diff:(t,s)=>p(Object.entries(t.get()).reduce(((t,[n,r])=>(r===e.attributes[n]&&r===s.attr(n)||(t[n]=r),t)),{}))};return s}function f(t){const e={visible:t.visible,duration:t.duration||0,delay:t.delay||0,style:g(t.style),attr:p(t.attr)},s={getDuration:()=>e.duration,getDelay:()=>e.delay,getStyle:()=>e.style,getAttributes:()=>e.attr,getVisible:()=>e.visible,getTransitionType:t=>!e.visible&&t.getVisible()?r:e.visible&&!t.getVisible()?a:e.visible&&t.getVisible()?i:void 0};return s}function b(t){const s={selection:e.select(t),selectors:new Set((n=t,["#"+n.id].concat(n.classList.toString().split(" ").map((t=>"."+t)).sort()))),states:[]};var n;const o={};return o.init=t=>{const e=function(t){return{getTransitions:()=>l(t.map((t=>t.update)).concat(t.map((t=>t.enter))).concat(t.map((t=>t.exit))).filter((t=>void 0!==t)).flat()),getFrames:()=>t.map(y)}}(t),n=e.getTransitions();let i="none"!==s.selection.style("display");const c=n.getStyle(s.selection),u=n.getAttributes(s.selection);return s.states.push(f({visible:i,duration:0,delay:0,style:c,attr:u})),e.getFrames().forEach((t=>{const e=t.getRelevantEntries(s.selectors);switch(void 0!==e.getType()&&(Object.assign(c,e.getStyle()),Object.assign(u,e.getAttributes())),e.getType()){case r:i=!0;break;case a:i=!1}s.states.push(f({visible:i,duration:e.getMaxDuration(),delay:e.getMaxDelay(),style:c,attr:u}))})),o},o.toFrame=(t,e)=>{const n=s.states[t].getTransitionType(s.states[e]),l=s.states[e].getDuration()||s.states[t].getDuration(),c=s.states[e].getDelay()||s.states[t].getDelay();switch(n){case r:{const n=s.states[t].getStyle().apply(s.selection).style("display",null).interrupt().transition().duration(l).delay(c);s.states[e].getStyle().apply(n),s.states[e].getAttributes().apply(n);break}default:case i:{const r=void 0===n?s.selection:s.selection.interrupt().transition().duration(l).delay(c);s.states[t].getStyle().diff(s.states[e].getStyle(),s.selection).apply(r),s.states[t].getAttributes().diff(s.states[e].getAttributes(),s.selection).apply(r);break}case a:{const t=s.selection.interrupt().transition().duration(l).delay(c).on("end",(()=>s.selection.style("display","none")));s.states[e].getStyle().apply(t),s.states[e].getAttributes().apply(t);break}}return o},o}t.Scene=function(t){const s={hidden:"mo",visible:"mo-v"},r="mo";let i={frames:[],current:0,objects:[]};function a(t){i.objects.forEach((e=>e.toFrame(i.current,t))),i.current=t}const o={forward:()=>(i.frames.length>i.current&&a(i.current+1),o),backward:()=>(i.current>0&&a(i.current-1),o),jumpTo:t=>(t!==i.current&&t>=0&&t<=i.frames.length&&a(t),o)};return o.init=a=>(i.frames=a.map(((t,e)=>Object.assign(t,{index:e}))),n(s.hidden,"div",[r],{display:"none",opacity:0}),n(s.visible,"div",[r]),i.objects=e.select(t).selectAll("."+r).nodes().map((t=>b(t).init(i.frames))),o),o.controls=t=>{const s=t.forward||[],n=t.backward||[],r=t.bookmarks||{};return e.select("body").on("keydown.controls",(t=>{if(s.indexOf(t.code)>-1)o.forward();else{n.indexOf(t.code)>-1&&o.backward();for(const e in r)t.code===e&&r.hasOwnProperty(e)&&o.jumpTo(r[e])}})),o},o},Object.defineProperty(t,"__esModule",{value:!0})}));
