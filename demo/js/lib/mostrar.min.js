// https://github.com/synesenom/mostrar v0.1.1 Copyright 2020 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3"),require("json-stable-stringify")):"function"==typeof define&&define.amd?define(["exports","d3","json-stable-stringify"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mostrar={},t.d3)}(this,(function(t,e){"use strict";function n(t,e,n,s){const r=document.createElement(e);for(let e=0;e<t.attributes.length;e++)r.setAttribute(t.attributes.item(e).nodeName,t.attributes.item(e).nodeValue);Array.isArray(n)&&r.classList.add(...n),"object"==typeof s&&Object.entries(s).forEach((([t,e])=>{r.style.setProperty(t,e)})),r.innerHTML=t.innerHTML,t.parentNode.replaceChild(r,t)}function s(t,e,s,r){let i=document.querySelector(t);for(;null!==i;)n(i,e,s,r),i=document.querySelector(t)}const r="enter",i="update",a="exit";function o(t){const e={attr:t.attr||{},style:t.style||{},delay:t.delay||0,duration:t.duration||0,selector:t.selector||[]},n={GET:()=>t,includes:t=>{const n=new Set(t||[]);return e.selector.filter((t=>n.has(t))).length>0},getAttributes:()=>e.attr,getStyle:()=>e.style,getDelay:()=>e.delay,getDuration:()=>e.duration};return n}function l(t,n){const s={transitions:(t||[]).map(o)},r={getType:()=>n,getAttributes:t=>{const e=s.transitions.map((t=>t.getAttributes())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((n=>{e[n]=t.attr(n)||null})),e},getStyle:t=>{const e=s.transitions.map((t=>t.getStyle())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((n=>{e[n]=t.style(n)||null})),e},getMaxDelay:()=>e.max(s.transitions.map((t=>t.getDelay())))||0,getMaxDuration:()=>e.max(s.transitions.map((t=>t.getDuration())))||0};return r}const c="enter",u="update",d="exit";function y(t){const e={enter:t.enter||[],exit:t.exit||[],update:t.update||[]};const n={};return n.getRelevantEntries=t=>{let n=function(t){return e.enter.map(o).filter((e=>e.includes(t))).map((t=>t.GET()))}(t);return n.length>0?l(n,c):(n=function(t){return e.update.map(o).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),n.length>0?l(n,u):(n=function(t){return e.exit.map(o).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),n.length>0?l(n,d):l()))},n}function g(t){const e={style:Object.assign({},t)},n={get:()=>e.style,apply:t=>(Object.entries(e.style).forEach((([e,n])=>t.style(e,n))),t),diff:(t,n)=>g(Object.entries(t.get()).reduce(((t,[s,r])=>(r===e.style[s]&&r===n.style(s)||(t[s]=r),t)),{}))};return n}function p(t){const e={attributes:Object.assign({},t)},n={get:()=>e.attributes,apply:t=>(Object.entries(e.attributes).forEach((([e,n])=>t.attr(e,n))),t),diff:(t,n)=>p(Object.entries(t.get()).reduce(((t,[s,r])=>(r===e.attributes[s]&&r===n.attr(s)||(t[s]=r),t)),{}))};return n}function f(t){const e={visible:t.visible,duration:t.duration||0,delay:t.delay||0,style:g(t.style),attr:p(t.attr)},n={getDuration:()=>e.duration,getDelay:()=>e.delay,getStyle:()=>e.style,getAttributes:()=>e.attr,getVisible:()=>e.visible,getTransitionType:t=>!e.visible&&t.getVisible()?r:e.visible&&!t.getVisible()?a:e.visible&&t.getVisible()?i:void 0};return n}function b(t){const n={selection:e.select(t),selectors:new Set((s=t,["#"+s.id].concat(s.classList.toString().split(" ").map((t=>"."+t)).sort()))),states:[]};var s;const o={};return o.init=t=>{const e=function(t){return{getTransitions:()=>l(t.map((t=>t.update)).concat(t.map((t=>t.enter))).concat(t.map((t=>t.exit))).filter((t=>void 0!==t)).flat()),getFrames:()=>t.map(y)}}(t),s=e.getTransitions();let i="none"!==n.selection.style("display");const c=s.getStyle(n.selection),u=s.getAttributes(n.selection);return n.states.push(f({visible:i,duration:0,delay:0,style:c,attr:u})),e.getFrames().forEach((t=>{const e=t.getRelevantEntries(n.selectors);switch(void 0!==e.getType()&&(Object.assign(c,e.getStyle()),Object.assign(u,e.getAttributes())),e.getType()){case r:i=!0;break;case a:i=!1}n.states.push(f({visible:i,duration:e.getMaxDuration(),delay:e.getMaxDelay(),style:c,attr:u}))})),o},o.toFrame=(t,e)=>{const s=n.states[t].getTransitionType(n.states[e]),l=n.states[e].getDuration()||n.states[t].getDuration(),c=n.states[e].getDelay()||n.states[t].getDelay();switch(s){case r:{const s=n.states[t].getStyle().apply(n.selection).style("display",null).interrupt().transition().duration(l).delay(c);n.states[e].getStyle().apply(s),n.states[e].getAttributes().apply(s);break}default:case i:{const r=void 0===s?n.selection:n.selection.interrupt().transition().duration(l).delay(c);n.states[t].getStyle().diff(n.states[e].getStyle(),n.selection).apply(r),n.states[t].getAttributes().diff(n.states[e].getAttributes(),n.selection).apply(r);break}case a:{const t=n.selection.interrupt().transition().duration(l).delay(c).on("end",(()=>n.selection.style("display","none")));n.states[e].getStyle().apply(t),n.states[e].getAttributes().apply(t);break}}return o},o}t.Scene=function(t){const n={hidden:"mo",visible:"mo-v"},r="mo";let i={frames:[],current:0,objects:[]};function a(t){i.objects.forEach((e=>e.toFrame(i.current,t))),i.current=t}const o={forward:()=>(i.frames.length>i.current&&a(i.current+1),o),backward:()=>(i.current>0&&a(i.current-1),o),jumpTo:t=>(t!==i.current&&t>=0&&t<=i.frames.length&&a(t),o)};return o.init=a=>(i.frames=a.map(((t,e)=>Object.assign(t,{index:e}))),s(n.hidden,"div",[r],{display:"none",opacity:0}),s(n.visible,"div",[r]),i.objects=e.select(t).selectAll("."+r).nodes().map((t=>b(t).init(i.frames))),o),o.controls=t=>{const n=t.forward||[],s=t.backward||[],r=t.bookmarks||{};return e.select("body").on("keydown.controls",(()=>{if(n.indexOf(e.event.code)>-1)o.forward();else{s.indexOf(e.event.code)>-1&&o.backward();for(const t in r)e.event.code===t&&r.hasOwnProperty(t)&&o.jumpTo(r[t])}})),o},o},Object.defineProperty(t,"__esModule",{value:!0})}));
