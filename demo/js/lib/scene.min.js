// todo v1.0.0 Copyright 2020 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3")):"function"==typeof define&&define.amd?define(["d3"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).Scene=e(t.d3)}(this,(function(t){"use strict";function e(t){let e={GET:()=>t};return e}function n(n){const s="enter",r="update",o="exit",i={id:n.id,selection:t.select(n),selectors:new Set((a=n,["#"+a.id].concat(a.classList.toString().split(" ").map((t=>"."+t)).sort()))),states:[]};var a;function c(t){return t.filter((t=>i.selectors.has(t))).length>0}function l(t,e){return Object.keys(t).forEach((n=>{t[n]=i.selection[e](n)||null})),t}function u(e){return t.max((e||[]).map((t=>t.duration||0)).concat(0))}function d(e){return t.max((e||[]).map((t=>t.delay||0)).concat(0))}function f(t){return t.map((t=>t.attr)).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{})}function y(t){return t.map((t=>t.style)).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{})}function p(t){let e=function(t){return(t.enter||[]).filter((t=>c(t.selector)))}(t);return e.length>0?{entries:e,type:s}:(e=function(t){return(t.update||[]).filter((t=>c(t.selector)))}(t),e.length>0?{entries:e,type:r}:(e=function(t){return(t.exit||[]).filter((t=>c(t.selector)))}(t),e.length>0?{entries:e,type:o}:{}))}function b(t,e){return Object.entries(e).forEach((([e,n])=>t.style(e,n))),t}function m(t,e){return Object.entries(e).forEach((([e,n])=>t.attr(e,n))),t}const h={init:t=>{let n="none"!==i.selection.style("display");const r=function(t){return t.map((t=>t.update)).concat(t.map((t=>t.enter))).concat(t.map((t=>t.exit))).filter((t=>void 0!==t)).flat()}(t),a=l(y(r),"style"),c=l(f(r),"attr");return i.states.push(e({id:0,visible:n,duration:0,delay:0,style:Object.assign({},a),attr:Object.assign({},c)})),t.forEach((t=>{const{entries:r,type:l}=p(t);switch(void 0!==r&&(Object.assign(a,y(r)),Object.assign(c,f(r))),l){case s:n=!0;break;case o:n=!1}i.states.push(e({id:t.id,visible:n,duration:u(r),delay:d(r),style:Object.assign({},a),attr:Object.assign({},c)}))})),h}};return h.toFrame=(t,e)=>{const n=(a=i.states[t].GET().visible,c=i.states[e].GET().visible,!a&&c?s:a&&!c?o:a&&c?r:void 0);var a,c;const l=i.states[e].GET().duration||i.states[t].GET().duration,u=i.states[e].GET().delay||i.states[t].GET().delay;switch(n){case s:{const n=b(i.selection,i.states[t].GET().style).style("display",null).interrupt().transition().duration(l).delay(u);b(n,i.states[e].GET().style),m(n,i.states[e].GET().attr);break}default:case r:{const s=void 0===n?i.selection:i.selection.interrupt().transition().duration(l).delay(u);b(s,function(t,e){const n={};for(const s in t)t.hasOwnProperty(s)&&e.hasOwnProperty(s)&&(t[s]!==e[s]||i.selection.style(s)!==e[s])&&(n[s]=e[s]);return n}(i.states[t].GET().style,i.states[e].GET().style)),m(s,function(t,e){const n={};for(const s in t)t.hasOwnProperty(s)&&e.hasOwnProperty(s)&&(t[s]!==e[s]||i.selection.attr(s)!==e[s])&&(n[s]=e[s]);return n}(i.states[t].GET().attr,i.states[e].GET().attr));break}case o:{const t=i.selection.interrupt().transition().duration(l).delay(u);b(t,i.states[e].GET().style),m(t,i.states[e].GET().attr),t.on("end",(()=>i.selection.style("display","none")));break}}return h},h}return function(e){let s={frames:[],current:0,objects:[]};function r(t){s.objects.map((e=>e.toFrame(s.current,t))),s.current=t}const o={forward:()=>(s.frames.length>s.current&&r(s.current+1),o),backward:()=>(s.current>0&&r(s.current-1),o),jumpTo:t=>(t!==s.current&&t>=0&&t<=s.frames.length&&r(t),o),init:r=>(s.frames=r,s.objects=t.select(e).selectAll(".obj").nodes().map((t=>n(t).init(s.frames))),o),controls:e=>{const n=e.forward||[],s=e.backward||[],r=e.bookmarks||{};return t.select("body").on("keydown.controls",(t=>{if(n.indexOf(t.code)>-1)o.forward();else{s.indexOf(t.code)>-1&&o.backward();for(const e in r)t.code===e&&r.hasOwnProperty(e)&&o.jumpTo(r[e])}})),o}};return o}}));
