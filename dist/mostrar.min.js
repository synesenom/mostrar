// https://github.com/synesenom/mostrar v0.0.1 Copyright 2020 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3"),require("json-stable-stringify")):"function"==typeof define&&define.amd?define(["exports","d3","json-stable-stringify"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mostrar={},t.d3)}(this,(function(t,e){"use strict";const s="enter",n="update",r="exit";function i(t){const e={attr:t.attr||{},style:t.style||{},delay:t.delay||0,duration:t.duration||0,selector:t.selector||[]},s={GET:()=>t,includes:t=>{const s=new Set(t||[]);return e.selector.filter((t=>s.has(t))).length>0},getAttributes:()=>e.attr,getStyle:()=>e.style,getDelay:()=>e.delay,getDuration:()=>e.duration};return s}function a(t,s){const n={transitions:(t||[]).map(i)},r={getType:()=>s,getAttributes:t=>{const e=n.transitions.map((t=>t.getAttributes())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((s=>{e[s]=t.attr(s)||null})),e},getStyle:t=>{const e=n.transitions.map((t=>t.getStyle())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((s=>{e[s]=t.style(s)||null})),e},getMaxDelay:()=>e.max(n.transitions.map((t=>t.getDelay())))||0,getMaxDuration:()=>e.max(n.transitions.map((t=>t.getDuration())))||0};return r}const o="enter",l="update",c="exit";function u(t){const e={enter:t.enter||[],exit:t.exit||[],update:t.update||[]};const s={};return s.getRelevantEntries=t=>{let s=function(t){return e.enter.map(i).filter((e=>e.includes(t))).map((t=>t.GET()))}(t);return s.length>0?a(s,o):(s=function(t){return e.update.map(i).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),s.length>0?a(s,l):(s=function(t){return e.exit.map(i).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),s.length>0?a(s,c):a()))},s}function d(t){const e={style:Object.assign({},t)},s={get:()=>e.style,apply:t=>(Object.entries(e.style).forEach((([e,s])=>t.style(e,s))),t),diff:(t,s)=>d(Object.entries(t.get()).reduce(((t,[n,r])=>(r===e.style[n]&&r===s.style(n)||(t[n]=r),t)),{}))};return s}function y(t){const e={attributes:Object.assign({},t)},s={get:()=>e.attributes,apply:t=>(Object.entries(e.attributes).forEach((([e,s])=>t.attr(e,s))),t),diff:(t,s)=>y(Object.entries(t.get()).reduce(((t,[n,r])=>(r===e.attributes[n]&&r===s.attr(n)||(t[n]=r),t)),{}))};return s}function g(t){const e={id:t.id,visible:t.visible,duration:t.duration||0,delay:t.delay||0,style:d(t.style),attr:y(t.attr)},i={getDuration:()=>e.duration,getDelay:()=>e.delay,getStyle:()=>e.style,getAttributes:()=>e.attr,getVisible:()=>e.visible,getTransitionType:t=>!e.visible&&t.getVisible()?s:e.visible&&!t.getVisible()?r:e.visible&&t.getVisible()?n:void 0};return i}function p(t){const i={selection:e.select(t),selectors:new Set((o=t,["#"+o.id].concat(o.classList.toString().split(" ").map((t=>"."+t)).sort()))),states:[]};var o;const l={};return l.init=t=>{const e=function(t){return{getTransitions:()=>a(t.map((t=>t.update)).concat(t.map((t=>t.enter))).concat(t.map((t=>t.exit))).filter((t=>void 0!==t)).flat()),getFrames:()=>t.map(u)}}(t),n=e.getTransitions();let o="none"!==i.selection.style("display");const c=n.getStyle(i.selection),d=n.getAttributes(i.selection);return i.states.push(g({visible:o,duration:0,delay:0,style:c,attr:d})),e.getFrames().forEach((t=>{const e=t.getRelevantEntries(i.selectors);switch(void 0!==e.getType()&&(Object.assign(c,e.getStyle()),Object.assign(d,e.getAttributes())),e.getType()){case s:o=!0;break;case r:o=!1}i.states.push(g({visible:o,duration:e.getMaxDuration(),delay:e.getMaxDelay(),style:c,attr:d}))})),l},l.toFrame=(t,e)=>{const a=i.states[t].getTransitionType(i.states[e]),o=i.states[e].getDuration()||i.states[t].getDuration(),c=i.states[e].getDelay()||i.states[t].getDelay();switch(a){case s:{const s=i.states[t].getStyle().apply(i.selection).style("display",null).interrupt().transition().duration(o).delay(c);i.states[e].getStyle().apply(s),i.states[e].getAttributes().apply(s);break}default:case n:{const s=void 0===a?i.selection:i.selection.interrupt().transition().duration(o).delay(c);i.states[t].getStyle().diff(i.states[e].getStyle(),i.selection).apply(s),i.states[t].getAttributes().diff(i.states[e].getAttributes(),i.selection).apply(s);break}case r:{const t=i.selection.interrupt().transition().duration(o).delay(c).on("end",(()=>i.selection.style("display","none")));i.states[e].getStyle().apply(t),i.states[e].getAttributes().apply(t);break}}return l},l}t.Scene=function(t){let s={frames:[],current:0,objects:[]};function n(t){s.objects.map((e=>e.toFrame(s.current,t))),s.current=t}const r={forward:()=>(s.frames.length>s.current&&n(s.current+1),r),backward:()=>(s.current>0&&n(s.current-1),r),jumpTo:t=>(t!==s.current&&t>=0&&t<=s.frames.length&&n(t),r),init:n=>(s.frames=n,s.objects=e.select(t).selectAll(".obj").nodes().map((t=>p(t).init(s.frames))),r),controls:t=>{const s=t.forward||[],n=t.backward||[],i=t.bookmarks||{};return e.select("body").on("keydown.controls",(t=>{if(s.indexOf(t.code)>-1)r.forward();else{n.indexOf(t.code)>-1&&r.backward();for(const e in i)t.code===e&&i.hasOwnProperty(e)&&r.jumpTo(i[e])}})),r}};return r},Object.defineProperty(t,"__esModule",{value:!0})}));
