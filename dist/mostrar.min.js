// https://github.com/synesenom/mostrar v0.0.1 Copyright 2020 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mostrar={},t.d3)}(this,(function(t,e){"use strict";function n(t){const n="enter",s="update",r="exit",o={id:t.id,selection:e.select(t),selectors:new Set((a=t,["#"+a.id].concat(a.classList.toString().split(" ").map((t=>"."+t)).sort()))),states:[]};var a;function i(t){return t.filter((t=>o.selectors.has(t))).length>0}function c(t,e){return Object.keys(t).forEach((n=>{t[n]=o.selection[e](n)||null})),t}function l(t){return e.max((t||[]).map((t=>t.duration||0)).concat(0))}function u(t){return e.max((t||[]).map((t=>t.delay||0)).concat(0))}function d(t){return t.map((t=>t.attr)).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{})}function f(t){return t.map((t=>t.style)).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{})}function y(t){let e=function(t){return(t.enter||[]).filter((t=>i(t.selector)))}(t);return e.length>0?{entries:e,type:n}:(e=function(t){return(t.update||[]).filter((t=>i(t.selector)))}(t),e.length>0?{entries:e,type:s}:(e=function(t){return(t.exit||[]).filter((t=>i(t.selector)))}(t),e.length>0?{entries:e,type:r}:{}))}function p(t,e){return Object.entries(e).forEach((([e,n])=>t.style(e,n))),t}function b(t,e){return Object.entries(e).forEach((([e,n])=>t.attr(e,n))),t}const m={init:t=>{let e="none"!==o.selection.style("display");const s=function(t){return t.map((t=>t.update)).concat(t.map((t=>t.enter))).concat(t.map((t=>t.exit))).filter((t=>void 0!==t)).flat()}(t),a=c(f(s),"style"),i=c(d(s),"attr");return o.states.push({id:0,visible:e,duration:0,delay:0,style:Object.assign({},a),attr:Object.assign({},i)}),t.forEach((t=>{const{entries:s,type:c}=y(t);switch(void 0!==s&&(Object.assign(a,f(s)),Object.assign(i,d(s))),c){case n:e=!0;break;case r:e=!1}o.states.push({id:t.id,visible:e,duration:l(s),delay:u(s),style:Object.assign({},a),attr:Object.assign({},i)})})),m}};return m.toFrame=(t,e)=>{const a=(i=o.states[t].visible,c=o.states[e].visible,!i&&c?n:i&&!c?r:i&&c?s:void 0);var i,c;const l=o.states[e].duration||o.states[t].duration,u=o.states[e].delay||o.states[t].delay;switch(a){case n:{const n=p(o.selection,o.states[t].style).style("display",null).interrupt().transition().duration(l).delay(u);p(n,o.states[e].style),b(n,o.states[e].attr);break}default:case s:{const n=void 0===a?o.selection:o.selection.interrupt().transition().duration(l).delay(u);p(n,function(t,e){const n={};for(const s in t)t.hasOwnProperty(s)&&e.hasOwnProperty(s)&&(t[s]!==e[s]||o.selection.style(s)!==e[s])&&(n[s]=e[s]);return n}(o.states[t].style,o.states[e].style)),b(n,function(t,e){const n={};for(const s in t)t.hasOwnProperty(s)&&e.hasOwnProperty(s)&&(t[s]!==e[s]||o.selection.attr(s)!==e[s])&&(n[s]=e[s]);return n}(o.states[t].attr,o.states[e].attr));break}case r:{const t=o.selection.interrupt().transition().duration(l).delay(u);p(t,o.states[e].style),b(t,o.states[e].attr),t.on("end",(()=>o.selection.style("display","none")));break}}return m},m}t.Scene=function(t){let s={frames:[],current:0,objects:[]};function r(t){s.objects.map((e=>e.toFrame(s.current,t))),s.current=t}const o={forward:()=>(s.frames.length>s.current&&r(s.current+1),o),backward:()=>(s.current>0&&r(s.current-1),o),jumpTo:t=>(t!==s.current&&t>=0&&t<=s.frames.length&&r(t),o),init:r=>(s.frames=r,s.objects=e.select(t).selectAll(".obj").nodes().map((t=>n(t).init(s.frames))),o),controls:t=>{const n=t.forward||[],s=t.backward||[],r=t.bookmarks||{};return e.select("body").on("keydown.controls",(t=>{if(n.indexOf(t.code)>-1)o.forward();else{s.indexOf(t.code)>-1&&o.backward();for(const e in r)t.code===e&&r.hasOwnProperty(e)&&o.jumpTo(r[e])}})),o}};return o},Object.defineProperty(t,"__esModule",{value:!0})}));
