// https://github.com/synesenom/mostrar v0.1.5 Copyright 2020 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3"),require("js-yaml")):"function"==typeof define&&define.amd?define(["exports","d3","js-yaml"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mostrar={},t.d3,t.jsyaml)}(this,(function(t,e,n){"use strict";function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=s(n);const a="enter",i="update",o="exit";function l(t){const e={attr:t.attr||{},style:t.style||{},delay:t.delay||0,duration:t.duration||0,selector:t.selector||[]},n={GET:()=>t,includes:t=>{const n=new Set(t||[]);return e.selector.filter((t=>n.has(t))).length>0},getAttributes:()=>e.attr,getStyle:()=>e.style,getDelay:()=>e.delay,getDuration:()=>e.duration};return n}function c(t,n){const s={transitions:(t||[]).map(l)},r={getType:()=>n,getAttributes:t=>{const e=s.transitions.map((t=>t.getAttributes())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((n=>{e[n]=t.attr(n)||null})),e},getStyle:t=>{const e=s.transitions.map((t=>t.getStyle())).filter((t=>void 0!==t)).reduce(((t,e)=>Object.assign(t,e)),{});return void 0!==t&&Object.keys(e).forEach((n=>{e[n]=t.style(n)||null})),e},getMaxDelay:()=>e.max(s.transitions.map((t=>t.getDelay())))||0,getMaxDuration:()=>e.max(s.transitions.map((t=>t.getDuration())))||0};return r}const u="enter",d="update",y="exit";function p(t){const e={enter:t.enter||[],exit:t.exit||[],update:t.update||[]};const n={};return n.getRelevantEntries=t=>{let n=function(t){return e.enter.map(l).filter((e=>e.includes(t))).map((t=>t.GET()))}(t);return n.length>0?c(n,u):(n=function(t){return e.update.map(l).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),n.length>0?c(n,d):(n=function(t){return e.exit.map(l).filter((e=>e.includes(t))).map((t=>t.GET()))}(t),n.length>0?c(n,y):c()))},n}function g(t){const e={style:Object.assign({},t)},n={get:()=>e.style,apply:t=>(Object.entries(e.style).forEach((([e,n])=>t.style(e,n))),t),diff:(t,n)=>g(Object.entries(t.get()).reduce(((t,[s,r])=>(r===e.style[s]&&r===n.style(s)||(t[s]=r),t)),{}))};return n}function f(t){const e={attributes:Object.assign({},t)},n={get:()=>e.attributes,apply:t=>(Object.entries(e.attributes).forEach((([e,n])=>t.attr(e,n))),t),diff:(t,n)=>f(Object.entries(t.get()).reduce(((t,[s,r])=>(r===e.attributes[s]&&r===n.attr(s)||(t[s]=r),t)),{}))};return n}function b(t){const e={visible:t.visible,duration:t.duration||0,delay:t.delay||0,style:g(t.style),attr:f(t.attr)},n={getDuration:()=>e.duration,getDelay:()=>e.delay,getStyle:()=>e.style,getAttributes:()=>e.attr,getVisible:()=>e.visible,getTransitionType:t=>!e.visible&&t.getVisible()?a:e.visible&&!t.getVisible()?o:e.visible&&t.getVisible()?i:void 0};return n}function m(t){const n={selection:e.select(t),selectors:new Set((s=t,["#"+s.id].concat(s.classList.toString().split(" ").map((t=>"."+t)).sort()))),states:[]};var s;const r={};return r.init=t=>{const e=function(t){return{getTransitions:()=>c(t.map((t=>t.update)).concat(t.map((t=>t.enter))).concat(t.map((t=>t.exit))).filter((t=>void 0!==t)).flat()),getFrames:()=>t.map(p)}}(t),s=e.getTransitions();let i="none"!==n.selection.style("display");const l=s.getStyle(n.selection),u=s.getAttributes(n.selection);return n.states.push(b({visible:i,duration:0,delay:0,style:l,attr:u})),e.getFrames().forEach((t=>{const e=t.getRelevantEntries(n.selectors);switch(void 0!==e.getType()&&(Object.assign(l,e.getStyle()),Object.assign(u,e.getAttributes())),e.getType()){case a:i=!0;break;case o:i=!1}n.states.push(b({visible:i,duration:e.getMaxDuration(),delay:e.getMaxDelay(),style:l,attr:u}))})),r},r.toFrame=(t,e)=>{const s=n.states[t].getTransitionType(n.states[e]),l=n.states[e].getDuration()||n.states[t].getDuration(),c=n.states[e].getDelay()||n.states[t].getDelay();switch(s){case a:{const s=n.states[t].getStyle().apply(n.selection).style("display",null).interrupt().transition().duration(l).delay(c);n.states[e].getStyle().apply(s),n.states[e].getAttributes().apply(s);break}default:case i:{const r=void 0===s?n.selection:n.selection.interrupt().transition().duration(l).delay(c);n.states[t].getStyle().diff(n.states[e].getStyle(),n.selection).apply(r),n.states[t].getAttributes().diff(n.states[e].getAttributes(),n.selection).apply(r);break}case o:{const t=n.selection.interrupt().transition().duration(l).delay(c).on("end",(()=>n.selection.style("display","none")));n.states[e].getStyle().apply(t),n.states[e].getAttributes().apply(t);break}}return r},r}t.Scene=function(t){const n="mo";let s={frames:[],current:0,objects:[]};function a(t){return Object.entries(t||[]).map((([t,e])=>Object.assign(e,{selector:t.split(" ")})))}function i(t){s.objects.forEach((e=>e.toFrame(s.current,t))),s.current=t}const o={forward:()=>(s.frames.length>s.current&&i(s.current+1),o),backward:()=>(s.current>0&&i(s.current-1),o),jumpTo:t=>(t!==s.current&&t>=0&&t<=s.frames.length&&i(t),o),init:async i=>{const l=r.default.load(await e.text(i));return s.frames=Object.entries(l).map((([t,e])=>({name:t,enter:a(e.enter),update:a(e.update),exit:a(e.exit)}))).sort(((t,e)=>t.name.localeCompare(e.name))).map(((t,e)=>Object.assign(t,{index:e}))),s.objects=e.select(t).selectAll("."+n).nodes().map((t=>m(t).init(s.frames))),o},controls:t=>{const n=t.forward||[],s=t.backward||[],r=t.bookmarks||{};return e.select("body").on("keydown.controls",(()=>{if(n.indexOf(e.event.code)>-1)o.forward();else{s.indexOf(e.event.code)>-1&&o.backward();for(const t in r)e.event.code===t&&r.hasOwnProperty(t)&&o.jumpTo(r[t])}})),o}};return o},Object.defineProperty(t,"__esModule",{value:!0})}));
